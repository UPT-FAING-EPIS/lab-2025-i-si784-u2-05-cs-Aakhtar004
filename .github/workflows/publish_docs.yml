name: 2. Publish Documentation

env:
  DOTNET_VERSION: '8.0'
  DOTNET_VERSION_TOOL: '6.0'

on: push

jobs:
  build-and-deploy-docs:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Bank

    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Configurando la versiÃ³n de NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Compatibilidad con .NET 6
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION_TOOL }}
    
    - name: Actualizar DocFx y dll2mmd  
      run: |
        dotnet tool update -g docfx
        dotnet tool update -g dll2mmd

    - name: Restore & Build project
      run: |
        dotnet restore Bank.Domain/Bank.Domain.csproj
        dotnet build Bank.Domain/Bank.Domain.csproj --configuration Release

    - name: Generar diagrama de clases con dll2mmd
      run: |
        dll2mmd -f Bank.Domain/bin/Release/net8.0/Bank.Domain.dll -o clases.md
    
    - name: Generate coverage Report
      run: |
        dotnet test --collect:"XPlat Code Coverage"
        dotnet tool install -g dotnet-reportgenerator-globaltool
        reportgenerator "-reports:./*/*/*/coverage.cobertura.xml" "-targetdir:Cobertura" -reporttypes:MarkdownSummaryGithub
    
    - name: Inicializar DocFX
      run: |
          docfx init -y
    
    - name: Limpiar el directorio docs
      run: |
          rm -rf docs/*
    
    - name: Modificar archivo docfx.json
      run: |
        cat > docfx.json <<EOF
        {
          "$schema": "https://raw.githubusercontent.com/dotnet/docfx/main/schemas/docfx.schema.json",
          "metadata": [
            {
              "src": [
                {
                  "src": ".",
                  "files": [
                    "**/*.csproj"
                  ]
                }
              ],
              "dest": "docs"
            }
          ],
          "build": {
            "content": [
              {
                "files": [
                  "**/*.{md,yml}"
                ],
                "exclude": [
                  "_site/**",
                  "Cobertura/index.html",
                  "Stryker/mutation-report.html"
                ]
              }
            ],
            "resource": [
              {
                "files": [
                  "images/**"
                ]
              }
            ],
            "output": "_site",
            "template": [
              "default",
              "modern"
            ],
            "globalMetadata": {
              "_appName": "Bank.App",
              "_appTitle": "Bank App",
              "_enableSearch": true,
              "pdf": true
            }
          }
        }
        EOF
    
    - name: VER JSON
      run: cat docfx.json
    
    - name: Modificar archivo toc.yml
      run: |
        cat > toc.yml <<EOF
        - name: Docs
          href: docs/
        EOF
    
    - name: Modificar archivo index.md
      run: |
        cat > index.md <<EOF
        ---
        _layout: landing
        ---

        # This is the **HOMEPAGE**.

        ## [Reporte Cobertura HTML](Cobertura/index.html)
        
        ## [Reporte de Mutaciones](Stryker/mutation-report.html)

        ## [Documentacion de Clases, atributos y mÃ©todos](docs/Bank.Domain.html)

        ## [Diagrama de Clases](clases.md)
        EOF
    
    - name: Verificar estructura del proyecto
      run: |
        echo "=== Estructura del proyecto Bank.Domain ==="
        find Bank.Domain -name "*.cs" | head -10
        echo ""
        echo "=== Clases pÃºblicas encontradas ==="
        find Bank.Domain -name "*.cs" -exec grep -l "public class\|public interface\|public enum" {} \; || echo "âŒ No se encontraron clases pÃºblicas"
        echo ""
        echo "=== Contenido del proyecto .csproj ==="
        cat Bank.Domain/Bank.Domain.csproj

    - name: Generar documentaciÃ³n
      run: |
        echo "=== Ejecutando docfx metadata ==="
        docfx metadata docfx.json --verbose
        echo ""
        echo "=== Verificando archivos generados despuÃ©s de metadata ==="
        ls -la docs/ || echo "âŒ Carpeta docs vacÃ­a"
        echo ""
        echo "=== Ejecutando docfx build ==="
        docfx build docfx.json --verbose
    
    - name: Verificar archivos generados DETALLADO
      run: |
        echo "=== Contenido completo de _site ==="
        find _site -type f -name "*.html" | sort
        echo ""
        echo "=== Contenido de docs/ ==="
        ls -la docs/ || echo "âŒ Carpeta docs no existe despuÃ©s de metadata"
        echo ""
        echo "=== Archivos YML generados ==="
        find docs/ -name "*.yml" 2>/dev/null || echo "âŒ No se encontraron archivos YML"
        echo ""
        echo "=== Verificando docs/Bank.Domain.html ==="
        ls -la _site/docs/ || echo "âŒ Carpeta _site/docs no encontrada"
        test -f _site/docs/Bank.Domain.html && echo "âœ… Bank.Domain.html encontrado" || echo "âŒ Bank.Domain.html NO encontrado"

    - name: ANÃLISIS COMPLETO DE GENERACIÃ“N - Rastrear todos los archivos
      run: |
        echo "ğŸ”¬ === ANÃLISIS DETALLADO DE GENERACIÃ“N DE ARCHIVOS ==="
        echo ""
        
        echo "ğŸ“ === 1. UBICACIÃ“N DE ARCHIVOS CRÃTICOS ==="
        echo "ğŸ” Buscando index.html en TODO el sistema:"
        find . -name "index.html" -type f 2>/dev/null | while read file; do
          echo "  ğŸ“„ $file - TamaÃ±o: $(du -h "$file" | cut -f1)"
        done
        echo ""
        
        echo "ğŸ” Buscando Bank.Domain.html en TODO el sistema:"
        find . -name "*Bank.Domain*" -type f 2>/dev/null | while read file; do
          echo "  ğŸ“„ $file - TamaÃ±o: $(du -h "$file" | cut -f1)"
        done
        echo ""
        
        echo "ğŸ” Buscando archivos de cobertura:"
        find . -path "*/Cobertura/*" -name "*.html" -type f 2>/dev/null | while read file; do
          echo "  ğŸ“Š $file - TamaÃ±o: $(du -h "$file" | cut -f1)"
        done
        echo ""
        
        echo "ğŸ“ === 2. ESTRUCTURA COMPLETA DE DIRECTORIOS ==="
        echo "ğŸ—ï¸ Estructura del directorio actual:"
        tree -L 3 2>/dev/null || find . -type d | head -20 | sort
        echo ""
        
        echo "ğŸ“ === 3. COMPARACIÃ“N: ANTES vs DESPUÃ‰S DE DocFX ==="
        echo "ğŸ“Š Archivos en Cobertura/ (ANTES de DocFX):"
        if [ -d "Cobertura" ]; then
          ls -la Cobertura/ | grep -E "\\.html$|\\.htm$"
        else
          echo "  âŒ Carpeta Cobertura no existe"
        fi
        echo ""
        
        echo "ğŸ“Š Archivos en _site/Cobertura/ (DESPUÃ‰S de DocFX):"
        if [ -d "_site/Cobertura" ]; then
          ls -la _site/Cobertura/ | grep -E "\\.html$|\\.htm$"
        else
          echo "  âŒ Carpeta _site/Cobertura no existe"
        fi
        echo ""
        
        echo "ğŸ“‹ === 4. RASTREO DE ARCHIVOS YAML/YML ==="
        echo "ğŸ” Archivos YAML generados por DocFX metadata:"
        find . -name "*.yml" -o -name "*.yaml" | while read file; do
          echo "  ğŸ“ $file:"
          if [ -s "$file" ]; then
            echo "    âœ… TamaÃ±o: $(du -h "$file" | cut -f1)"
            echo "    ğŸ“„ Primeras 3 lÃ­neas:"
            head -3 "$file" | sed 's/^/      /'
          else
            echo "    âŒ Archivo vacÃ­o"
          fi
          echo ""
        done
        
        echo "ğŸ¯ === 5. ANÃLISIS DE LA CONFIGURACIÃ“N DocFX ==="
        echo "ğŸ“‹ ConfiguraciÃ³n actual de docfx.json - secciÃ³n resources:"
        if [ -f "docfx.json" ]; then
          echo "  ğŸ“ Contenido completo de docfx.json:"
          cat docfx.json | jq . 2>/dev/null || cat docfx.json
        else
          echo "  âŒ docfx.json no encontrado"
        fi
        echo ""
        
        echo "ğŸ”„ === 6. PROCESO DE COPIA DE DocFX ==="
        echo "ğŸ“Š Verificando quÃ© archivos DocFX estÃ¡ procesando/copiando:"
        echo "  ğŸ“‚ Archivos que coinciden con 'images/**':"
        find . -path "*/images/*" -type f 2>/dev/null || echo "    âŒ No hay archivos en images/"
        echo ""
        echo "  ğŸ“‚ Archivos que coinciden con '**/*.{md,yml}':"
        find . \( -name "*.md" -o -name "*.yml" \) -not -path "./_site/*" -type f | head -10
        echo ""
        
        echo "ğŸš« === 7. ARCHIVOS EXCLUIDOS ==="
        echo "ğŸ“‹ Verificando archivos excluidos por configuraciÃ³n:"
        echo "  âŒ Archivos excluidos explÃ­citamente:"
        [ -f "Cobertura/index.html" ] && echo "    ğŸš« Cobertura/index.html estÃ¡ EXCLUIDO en docfx.json" || echo "    â“ Cobertura/index.html no existe"
        [ -f "Stryker/mutation-report.html" ] && echo "    ğŸš« Stryker/mutation-report.html estÃ¡ EXCLUIDO en docfx.json" || echo "    â“ Stryker/mutation-report.html no existe"
        echo ""
        
        echo "ğŸ“¤ === 8. DESTINO FINAL DE PUBLICACIÃ“N ==="
        echo "ğŸ¯ Archivos que realmente se van a publicar en GitHub Pages:"
        if [ -d "_site" ]; then
          echo "  ğŸ“Š Total de archivos en _site: $(find _site -type f | wc -l)"
          echo "  ğŸ“„ Archivos HTML en _site:"
          find _site -name "*.html" -type f | while read file; do
            relpath=${file#_site/}
            echo "    âœ… $relpath - $(du -h "$file" | cut -f1)"
          done
        else
          echo "  âŒ Directorio _site no existe"
        fi
        echo ""
        
        echo "ğŸŒ === 9. URLs FINALES ESPERADAS ==="
        echo "ğŸ”— URLs que deberÃ­an funcionar despuÃ©s de la publicaciÃ³n:"
        base_url="https://upt-faing-epis.github.io/lab-2025-i-si784-u2-05-cs-Aakhtar004/docs"
        echo "  ğŸ  PÃ¡gina principal: $base_url/index.html"
        [ -f "_site/Cobertura/index.html" ] && echo "  âœ… Cobertura: $base_url/Cobertura/index.html" || echo "  âŒ Cobertura: $base_url/Cobertura/index.html (FALTANTE)"
        [ -f "_site/docs/Bank.Domain.html" ] && echo "  âœ… API Docs: $base_url/docs/Bank.Domain.html" || echo "  âŒ API Docs: $base_url/docs/Bank.Domain.html (FALTANTE)"
        [ -f "_site/Stryker/mutation-report.html" ] && echo "  âœ… Mutaciones: $base_url/Stryker/mutation-report.html" || echo "  âŒ Mutaciones: $base_url/Stryker/mutation-report.html (FALTANTE)"
        [ -f "_site/clases.html" ] && echo "  âœ… Diagrama: $base_url/clases.html" || echo "  âŒ Diagrama: $base_url/clases.html (FALTANTE)"
        echo ""
        
        echo "âš ï¸ === 10. DIAGNÃ“STICO DE PROBLEMAS ==="
        echo "ğŸ” Identificando por quÃ© los archivos no estÃ¡n donde deberÃ­an:"
        echo ""
        echo "  ğŸ§ª PROBLEMA 1 - Cobertura:"
        if [ -f "Cobertura/index.html" ] && [ ! -f "_site/Cobertura/index.html" ]; then
          echo "    âŒ Cobertura/index.html existe pero NO se copia a _site/"
          echo "    ğŸ”§ CAUSA: EstÃ¡ EXCLUIDO en docfx.json o no incluido en resources"
        elif [ ! -f "Cobertura/index.html" ]; then
          echo "    âŒ Cobertura/index.html NO se estÃ¡ generando"
          echo "    ğŸ”§ CAUSA: reportgenerator no estÃ¡ generando HTML"
        else
          echo "    âœ… Cobertura OK"
        fi
        echo ""
        
        echo "  ğŸ§ª PROBLEMA 2 - API Documentation:"
        if [ ! -f "_site/docs/Bank.Domain.html" ]; then
          echo "    âŒ docs/Bank.Domain.html NO existe en _site/"
          if [ -z "$(find docs -name "*.yml" 2>/dev/null)" ]; then
            echo "    ğŸ”§ CAUSA: DocFX metadata no genera archivos YML (no hay clases pÃºblicas)"
          else
            echo "    ğŸ”§ CAUSA: DocFX build no procesa los archivos YML correctamente"
          fi
        else
          echo "    âœ… API Documentation OK"
        fi
        echo ""
        
        echo "  ğŸ§ª PROBLEMA 3 - Enlaces rotos:"
        if [ -f "_site/index.html" ]; then
          echo "    ğŸ” Enlaces en index.html que pueden estar rotos:"
          grep -o 'href="[^"]*"' _site/index.html | while read link; do
            file_path=$(echo "$link" | sed 's/href="//;s/"//')
            if [[ "$file_path" != http* ]] && [[ "$file_path" != "#"* ]]; then
              if [ ! -f "_site/$file_path" ]; then
                echo "    âŒ ENLACE ROTO: $link -> _site/$file_path no existe"
              else
                echo "    âœ… ENLACE OK: $link"
              fi
            fi
          done
        fi
        echo ""
        
        echo "ğŸ¯ === RESUMEN EJECUTIVO ==="
        echo "ğŸ“Š Archivos necesarios vs encontrados:"
        total_needed=4
        found=0
        [ -f "_site/index.html" ] && found=$((found+1))
        [ -f "_site/Cobertura/index.html" ] && found=$((found+1))
        [ -f "_site/docs/Bank.Domain.html" ] && found=$((found+1))
        [ -f "_site/clases.html" ] && found=$((found+1))
        echo "  ğŸ“ˆ Progreso: $found/$total_needed archivos principales encontrados"
        
        if [ $found -eq $total_needed ]; then
          echo "  ğŸ‰ Â¡Ã‰XITO! Todos los archivos estÃ¡n listos para publicaciÃ³n"
        else
          echo "  âš ï¸  FALTAN $(($total_needed - $found)) archivos crÃ­ticos"
          echo "  ğŸ”§ Revisar los problemas identificados arriba"
        fi

    - name: Publicar en GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: Bank/_site
        publish_branch: gh-pages
        destination_dir: docs
        keep_files: true